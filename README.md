# AvitoSecurity
### Анализ кода на безопасность

В данном коде присутствуют несколько уязвимостей, которые могут быть использованы злоумышленниками для эксплуатации системы. Ниже представлен анализ, описание уязвимостей, примеры эксплуатации, потенциальные последствия и рекомендации по их исправлению.

---

### 1. **SQL-инъекция**
   В коде используется небезопасный способ формирования SQL-запросов, что делает систему уязвимой к SQL-инъекциям.

   #### Уязвимость:
   В функции `show_order` SQL-запрос формируется с помощью строкового форматирования:
   ```python
   cursor = db_connection.execute(
       'select from "Orders" where id = {}'.format(order_id)
   )
   ```
   Если параметр `order_id` может быть изменён пользователем (например, передаётся через HTTP-запрос), злоумышленник может вставить вредоносный SQL-код.

   #### Пример эксплуатации:
   Если пользователь передаст значение `order_id` как `1 OR 1=1`, запрос будет выглядеть так:
   ```sql
   select from "Orders" where id = 1 OR 1=1
   ```
   Это приведёт к тому, что будут возвращены все заказы из таблицы "Orders", что нарушает конфиденциальность данных.

   #### Последствия:
   - Возможность чтения всех данных из базы.
   - Потенциальное изменение или удаление данных.
   - Полная компрометация базы данных.

   #### Рекомендация:
   Использовать параметризованные запросы для предотвращения SQL-инъекций:
   ```python
   cursor = db_connection.execute(
       'select from "Orders" where id = %s', (order_id,)
   )
   ```

---

### 2. **Недостаточная проверка данных пользователя**
   В коде используются проверки типов данных, но этого недостаточно для предотвращения некоторых атак.

   #### Уязвимость:
   В функции `add_to_order` выполняется проверка типов с помощью конструкции:
   ```python
   if not all(isinstance(p, int) for p in [user_id, order_id, item_id, quantity, price]):
       return {"error": "wrong type"}
   ```
   Эта проверка может быть недостаточной, поскольку не проверяются границы значений (например, отрицательные числа, слишком большие числа), а также не предотвращаются попытки передать вредоносные данные.

   #### Пример эксплуатации:
   Злоумышленник может передать отрицательные или нереалистично большие значения, например:
   ```python
   add_to_order(user_id=-1, order_id=9999999999999999, item_id=0, quantity=-100, price=-999)
   ```
   Это может привести к некорректным изменениям в базе данных, например к созданию неверных заказов.

   #### Последствия:
   - Возможность искажения данных в базе.
   - Потенциальная перегрузка системы.

   #### Рекомендация:
   Добавить валидацию данных, проверяя корректность их диапазонов. Например:
   ```python
   if user_id < 0 or order_id < 0 or item_id < 0 or quantity <= 0 or price <= 0:
       return {"error": "Invalid input values"}
   ```

---

### 3. **Проблемы с обработкой ошибок**
   В функции `show_order` используется некорректный подход к обработке ошибок, который может привести к утечке информации о системе.

   #### Уязвимость:
   Если происходит исключение, ошибка выводится в ответе пользователю:
   ```python
   return (
       f'<html><body><p>Error was happend for {order_id}</p></body></html>'
   )
   ```
   Это может дать злоумышленнику информацию о структуре системы, базе данных и других внутренних компонентах.

   #### Пример эксплуатации:
   Если запрос вызывает ошибку (например, при передаче несуществующего `order_id`), злоумышленник может получить подсказки о типах данных или внутренней структуре базы, что упростит дальнейшие атаки.

   #### Последствия:
   - Утечка информации, связанной с внутренним устройством системы.
   - Повышение риска целенаправленных атак.

   #### Рекомендация:
   Не выводить конкретные ошибки пользователю. Вместо этого логировать ошибки на сервере, а пользователю выдавать общее сообщение:
   ```python
   except Exception as e:
       log_error(e)
       return '<html><body><p>An error occurred. Please try again later.</p></body></html>'
   ```

---

### 4. **Возможная утечка информации через HTML**
   Вывод данных о заказе (`order_info`) прямо в HTML без экранирования может привести к XSS-уязвимостям.

   #### Уязвимость:
   В функции `show_order` информация о заказе вставляется в HTML без проверки на наличие вредоносного кода:
   ```python
   return f'<html><body><p>{order_info}</p></body></html>'
   ```
   Если злоумышленник может каким-либо образом изменить данные в заказе (например, через SQL-инъекцию), он сможет внедрить в HTML вредоносный JavaScript.

   #### Пример эксплуатации:
   Если поле в базе данных содержит скрипт:
   ```html
   <script>alert('XSS')</script>
   ```
   Этот скрипт будет выполнен у пользователя, что может привести к краже сессий, данных или взлому учётной записи.

   #### Последствия:
   - Возможность выполнения XSS-атак.
   - Компрометация данных пользователей.
   - Кража сессий и персональной информации.

   #### Рекомендация:
   Экранировать все данные перед выводом в HTML:
   ```python
   from html import escape
   return f'<html><body><p>{escape(order_info)}</p></body></html>'
   ```

---

### Общие рекомендации:

1. **Использовать параметризованные запросы**. Это предотвратит SQL-инъекции, так как запросы будут безопасно составляться с учётом переданных параметров.
   
2. **Экранировать данные при выводе в HTML**. Это убережёт от XSS-атак.

3. **Использовать безопасные методы обработки ошибок**. Ошибки должны логироваться на сервере, но не показываться пользователю в явном виде.

4. **Внедрить расширенную валидацию данных**. Проверять не только типы, но и диапазоны значений, формат данных и логику бизнес-процессов.

5. **Провести тестирование на уязвимости**. Использовать инструменты для статического анализа кода (SAST) и динамического тестирования на проникновение (DAST) для выявления дополнительных уязвимостей.

Внедрение указанных мер существенно повысит безопасность кода и снизит риски атак.
